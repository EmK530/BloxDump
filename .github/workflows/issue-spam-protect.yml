name: Auto-close issues from very new accounts

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  check-account-age:
    runs-on: ubuntu-latest
    steps:
      - name: Get issue author info
        id: user
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.issue.user.login;
            const { data: user } = await github.rest.users.getByUsername({
              username
            });
            const createdAt = new Date(user.created_at);
            const now = new Date();
            const ageInDays = (now - createdAt) / (1000 * 60 * 60 * 24);
            core.setOutput("age", ageInDays);
            core.setOutput("username", username);
      - name: Close issue if account is too new
        if: ${{ steps.user.outputs.age < 3 }}
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body: `Hello @${issue.user.login}!\n\nTo reduce automated spam, issues from very new GitHub accounts are automatically closed.\nIf this is a genuine report, feel free to reopen the issue and it won't be closed again.`
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: "closed",
              state_reason: "not_planned"
            });
